#!/bin/bash
# ğŸ• Watchdog - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç›£è¦–ãƒ»è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# Gemini APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã—ã€è‡ªå‹•ã§ã€Œ1. Keep tryingã€ã‚’é¸æŠ
#
# ä½¿ç”¨æ–¹æ³•:
#   ./watchdog.sh           # ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
#   ./watchdog.sh &         # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
#   nohup ./watchdog.sh &   # ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã‚‚ç¶™ç¶š
#
# åœæ­¢æ–¹æ³•:
#   pkill -f "watchdog.sh"

set -e

# è¨­å®š
INTERVAL=5  # ãƒã‚§ãƒƒã‚¯é–“éš”ï¼ˆç§’ï¼‰
ERROR_PATTERNS=(
    "high demand"
    "experiencing high demand"
    "1. Keep trying"
)

# è‰²ä»˜ããƒ­ã‚°é–¢æ•°
log_info() {
    echo -e "\033[1;33m[$(date '+%H:%M:%S')]\033[0m $1"
}

log_retry() {
    echo -e "\033[1;32m[$(date '+%H:%M:%S')]\033[0m ğŸ”„ $1"
}

# èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
echo ""
echo -e "\033[1;35mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\033[0m"
echo -e "\033[1;35mâ•‘\033[0m  ğŸ• \033[1;37mWatchdog\033[0m - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç›£è¦–ãƒ»è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤                 \033[1;35mâ•‘\033[0m"
echo -e "\033[1;35mâ•‘\033[0m     ç›£è¦–é–“éš”: ${INTERVAL}ç§’ | åœæ­¢: pkill -f 'watchdog.sh'           \033[1;35mâ•‘\033[0m"
echo -e "\033[1;35mâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"
echo ""

log_info "ç›£è¦–é–‹å§‹... (multiagent:0.0-8)"

# ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
while true; do
    for i in {0..8}; do
        # ãƒšã‚¤ãƒ³ã®å†…å®¹ã‚’å–å¾—ï¼ˆæœ€å¾Œã®15è¡Œï¼‰
        PANE_CONTENT=$(tmux capture-pane -t "multiagent:0.$i" -p 2>/dev/null | tail -15)
        
        # ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
        for pattern in "${ERROR_PATTERNS[@]}"; do
            if echo "$PANE_CONTENT" | grep -q "$pattern"; then
                log_retry "ãƒšã‚¤ãƒ³ $i ã§ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ¤œå‡º â†’ è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤é€ä¿¡"
                tmux send-keys -t "multiagent:0.$i" "1"
                sleep 0.3
                tmux send-keys -t "multiagent:0.$i" Enter
                # åŒã˜ãƒšã‚¤ãƒ³ã§è¤‡æ•°å›ãƒãƒƒãƒã—ãªã„ã‚ˆã†å°‘ã—å¾…æ©Ÿ
                sleep 1
                break
            fi
        done
    done
    sleep $INTERVAL
done
